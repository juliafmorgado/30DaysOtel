# Kubernetes Deployment for Gateway Pattern
# This deploys centralized Collector gateways with scaling

apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-gateway-config
  namespace: observability
data:
  config.yaml: |
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

    processors:
      batch:
        timeout: 5s
        send_batch_size: 2048
      
      memory_limiter:
        limit_mib: 1024
      
      attributes/enterprise:
        actions:
          - key: cluster.name
            value: "production-cluster"
            action: insert
          - key: environment
            value: "production"
            action: insert
      
      transform/business-logic:
        trace_statements:
          - context: span
            statements:
              - set(attributes["business.critical"], "true") where name matches ".*(payment|auth|billing).*"
              - set(attributes["business.critical"], "false") where attributes["business.critical"] == nil
      
      filter/cost-optimization:
        traces:
          span:
            - 'name matches ".*health.*" and attributes["http.status_code"] < 400'
            - 'duration < 1000000 and attributes["http.status_code"] < 400'

    exporters:
      otlp/production:
        endpoint: https://api.dash0.com:4317
        headers:
          authorization: "Bearer ${DASH0_API_TOKEN}"
        compression: gzip
        retry_on_failure:
          enabled: true
          max_elapsed_time: 300s
      
      logging:
        loglevel: debug
        sampling_initial: 5

    service:
      pipelines:
        traces:
          receivers: [otlp]
          processors: [memory_limiter, attributes/enterprise, transform/business-logic, filter/cost-optimization, batch]
          exporters: [otlp/production]
        
        metrics:
          receivers: [otlp]
          processors: [memory_limiter, attributes/enterprise, batch]
          exporters: [otlp/production]
        
        logs:
          receivers: [otlp]
          processors: [memory_limiter, attributes/enterprise, batch]
          exporters: [otlp/production]

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: otel-collector-gateway
  namespace: observability
  labels:
    app: otel-collector-gateway
spec:
  replicas: 3  # High availability
  selector:
    matchLabels:
      app: otel-collector-gateway
  template:
    metadata:
      labels:
        app: otel-collector-gateway
    spec:
      serviceAccountName: otel-collector-gateway
      containers:
      - name: otel-collector
        image: otel/opentelemetry-collector-contrib:0.91.0
        command:
          - "/otelcol-contrib"
          - "--config=/etc/otel-collector-config.yaml"
        env:
        - name: DASH0_API_TOKEN
          valueFrom:
            secretKeyRef:
              name: observability-secrets
              key: dash0-api-token
        resources:
          limits:
            memory: 2Gi
            cpu: 1000m
          requests:
            memory: 1Gi
            cpu: 500m
        ports:
        - containerPort: 4317
          name: otlp-grpc
          protocol: TCP
        - containerPort: 4318
          name: otlp-http
          protocol: TCP
        - containerPort: 8888
          name: metrics
          protocol: TCP
        volumeMounts:
        - name: config
          mountPath: /etc/otel-collector-config.yaml
          subPath: config.yaml
        livenessProbe:
          httpGet:
            path: /
            port: 13133
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /
            port: 13133
          initialDelaySeconds: 5
          periodSeconds: 10
      volumes:
      - name: config
        configMap:
          name: otel-collector-gateway-config

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: otel-collector-gateway
  namespace: observability

---
apiVersion: v1
kind: Service
metadata:
  name: otel-collector-gateway
  namespace: observability
  labels:
    app: otel-collector-gateway
spec:
  type: ClusterIP
  ports:
  - name: otlp-grpc
    port: 4317
    targetPort: 4317
    protocol: TCP
  - name: otlp-http
    port: 4318
    targetPort: 4318
    protocol: TCP
  - name: metrics
    port: 8888
    targetPort: 8888
    protocol: TCP
  selector:
    app: otel-collector-gateway

---
# Horizontal Pod Autoscaler for automatic scaling
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: otel-collector-gateway-hpa
  namespace: observability
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: otel-collector-gateway
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80

---
# Secret for API tokens (create this separately)
apiVersion: v1
kind: Secret
metadata:
  name: observability-secrets
  namespace: observability
type: Opaque
data:
  # Base64 encoded API token
  # echo -n "your-actual-api-token" | base64
  dash0-api-token: eW91ci1hY3R1YWwtYXBpLXRva2Vu