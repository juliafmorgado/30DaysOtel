# OpenTelemetry Collector Agent Configuration
# Deploy this close to applications (DaemonSet, sidecar, or per-host)
# Uses modern exporter-side batching for better reliability

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: localhost:4317  # Local only - applications connect here
      http:
        endpoint: localhost:4318

processors:
  # Basic filtering to reduce noise
  filter/health-checks:
    traces:
      span:
        - 'name matches ".*health.*" and attributes["http.response.status_code"] < 400'
  
  # Memory protection
  memory_limiter:
    limit_mib: 128

exporters:
  # Modern exporter with built-in batching and reliability
  otlp/backend:
    endpoint: https://api.dash0.com:4317
    headers:
      authorization: "Bearer YOUR_API_TOKEN"
    compression: gzip
    
    # Built-in batching (replaces batch processor)
    sending_queue:
      enabled: true
      queue_size: 512
      persistent_storage_enabled: true  # Survives crashes
    
    # Intelligent retry logic
    retry_on_failure:
      enabled: true
      initial_interval: 1s
      max_elapsed_time: 300s
  
  # Gateway option with same reliability features
  otlp/gateway:
    endpoint: https://gateway.company.com:4317
    compression: gzip
    sending_queue:
      enabled: true
      queue_size: 512
      persistent_storage_enabled: true
    retry_on_failure:
      enabled: true

service:
  extensions: []
  
  pipelines:
    traces:
      receivers: [otlp]
      processors: [memory_limiter, filter/health-checks]  # No batch processor needed
      exporters: [otlp/backend]  # Change to otlp/gateway for hybrid pattern
    
    metrics:
      receivers: [otlp]
      processors: [memory_limiter]
      exporters: [otlp/backend]
    
    logs:
      receivers: [otlp]
      processors: [memory_limiter]
      exporters: [otlp/backend]

  telemetry:
    logs:
      level: "info"
    metrics:
      address: localhost:8888  # Collector metrics endpoint